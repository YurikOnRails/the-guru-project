#!/usr/bin/env ruby
# frozen_string_literal: true

# Этот скрипт позволяет проверить правильность RAILS_MASTER_KEY и credentials
# Запуск: bin/check_credentials

require_relative "../config/environment"

begin
  # Пытаемся получить доступ к credentials
  Rails.application.credentials.secret_key_base
  puts "✅ Credentials доступны и корректно расшифрованы!"
  puts "✅ RAILS_MASTER_KEY работает правильно!"
  
  # Показываем доступные ключи (без значений)
  puts "\nДоступные ключи в credentials:"
  credentials = Rails.application.credentials.config
  
  def display_keys(hash, prefix = "")
    hash.each do |key, value|
      if value.is_a?(Hash)
        puts "#{prefix}#{key}:"
        display_keys(value, "#{prefix}  ")
      else
        puts "#{prefix}#{key}: [SECRET]"
      end
    end
  end
  
  display_keys(credentials)
  
rescue ActiveSupport::MessageEncryptor::InvalidMessage
  puts "❌ Ошибка: Невозможно расшифровать credentials!"
  puts "❌ Проверьте, что RAILS_MASTER_KEY содержит правильное значение"
  puts "   Текущее значение master.key может быть несовместимо с credentials.yml.enc"
  puts "\nРешения:"
  puts "1. Убедитесь, что правильный RAILS_MASTER_KEY установлен в переменных окружения"
  puts "2. Или пересоздайте credentials с помощью команды: bin/rails credentials:edit"
  exit(1)
rescue => e
  puts "❌ Непредвиденная ошибка: #{e.message}"
  puts e.backtrace.first(5)
  exit(1)
end 