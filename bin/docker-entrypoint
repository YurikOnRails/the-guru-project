#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Проверка подключения к PostgreSQL
echo "Checking PostgreSQL connection..."
# Пытаемся подключиться к БД, используя DATABASE_URL
DB_RETRY_DELAY=3
DB_MAX_RETRIES=20
DB_RETRY_COUNT=0

until bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')"; do
  DB_RETRY_COUNT=$((DB_RETRY_COUNT + 1))
  echo "Waiting for PostgreSQL to become available... (attempt $DB_RETRY_COUNT/$DB_MAX_RETRIES)"
  
  if [ $DB_RETRY_COUNT -eq $DB_MAX_RETRIES ]; then
    echo "Failed to connect to PostgreSQL after $DB_MAX_RETRIES attempts!"
    exit 1
  fi
  
  sleep $DB_RETRY_DELAY
done

echo "PostgreSQL is available"

# Run database migrations
./bin/rails db:prepare

# Execute the command
exec "${@}"
